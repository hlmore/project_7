---
title: "Citizen Science Visualization"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)

# primary data set - Earth Challenge Integrated Data: Plastic Pollution (MLW, MDMAP, TIDES)
# https://cscloud-ec2020.opendata.arcgis.com/
#read in necessary packages
library(tidyverse)
library(broom)
#read in data
all_plastics <-
  read_csv("plastic_pollution.csv",
    guess_max = 5000
  ) %>%
  rename(lat = Y,
         long = X)
str(all_plastics)
# #create bins for data
# lat_sum <- all_plastics %>%
#   group_by(COUNTRY) %>%
#   summarise(max_lat = max(Y),
#             min_lat = min(Y),
#             med_lat = median(Y),
#             max_long = max(X),
#             min_long = min(X),
#             med_lat = median(Y))
#SE ASIA:
##  long > 71 < 162
## lat > -16 < 33
## country: not Pakistan, China
se_asia <- all_plastics %>%
  filter(
    lat < 33,
    lat > -16,
    long > 71,
    long < 162,
    COUNTRY != "China",
    COUNTRY != "Australia",
    COUNTRY != "Pakistan"
  ) %>% 
  mutate(region = "southeast asia")
levels(as.factor(se_asia$COUNTRY))
  
#N ASIA:
##  long > 34 < 149
##  lat > 18
## country: not Pakistan, kyrgyzstan,
n_asia <- all_plastics %>%
  filter(
    lat > 18 ,
    long > 73,
    long < 149,
    COUNTRY != "Pakistan",
    COUNTRY != "Kyrgyzstan",
    COUNTRY != "Vietnam",
    COUNTRY != "Philippines",
    COUNTRY != "India"
  ) %>%
  mutate(region = "north asia")
#check countries for errors
levels(as.factor(n_asia$COUNTRY))
#Middle East:
mid_east <- all_plastics %>%
  filter(
    lat > 12 ,
    lat < 56,
    long > 27,
    long < 80,
    !COUNTRY %in% c(
      "Egypt",
      "Romania",
      "Ukraine",
      "Bulgaria",
      "India",
      "Greece",
      "Russian Federation"
    )
  ) %>%
  mutate(region = "middle east")
#check countries for errors
levels(as.factor(mid_east$COUNTRY))
#west coast NAmerica
na_west <- all_plastics %>%
  filter(lat > 15 ,
         lat < 83,
         long > -171,
         long < -99,
         !COUNTRY %in% c("Guatemala")) %>%
  mutate(region = "west north america")
#check countries for errors
levels(as.factor(na_west$COUNTRY))
#east coast NAmerica
na_east <- all_plastics %>%
  filter(lat > 15 ,
         lat < 83,
         long < -53 ,
         long > -99,
         COUNTRY %in% c("Canada", "Mexico", "United States")) %>%
  mutate(region = "east north america")
#check countries for errors
levels(as.factor(na_east$COUNTRY))
#Atlantic Islands
atl_isles <- all_plastics %>%
  filter(
    lat > 15 ,
    lat < 83,
    long < -53 ,
    long > -99,
    !COUNTRY %in% c("Canada", "Mexico", "United States", "Honduras", "Belize")
  ) %>%
  mutate(region = "atlantic islands")
#check countries for errors
levels(as.factor(atl_isles$COUNTRY)) #I MAY HAVE MISSED SOME SMALL ISLANDS NORTH OF SOUTH AMERICA -- grouping these with s america, because they're hard to grab with atl isles
#central america
cent_am <- all_plastics %>%
  filter(
    lat > 7 ,
    lat < 19,
    long > -92 ,
    long < -77,
    !COUNTRY %in% c("Canada", "Colombia", "Mexico", "Jamaica")
  )  %>%
  mutate(region = "central america")
#check countries for errors
levels(as.factor(cent_am$COUNTRY))
#west south america
w_south_am <- all_plastics %>%
  filter(
    lat > -55 ,
    lat < 13,
    long > -91 ,
    long < -61,
    !COUNTRY %in% c("Costa Rica", "Ecuador", "Nicaragua", "Panama")
  ) %>%
  mutate(region = "west south america")
#check countries for errors
levels(as.factor(w_south_am$COUNTRY))
#east south america
e_south_am <- all_plastics %>%
  filter(
    lat > -55 ,
    lat < 13,
    long > -61 ,
    long < -34,
    !COUNTRY %in% c("Costa Rica", "Ecuador", "Nicaragua", "Panama")
  ) %>%
  mutate(region = "east south america")
#check countries for errors
levels(as.factor(e_south_am$COUNTRY))
#europe
eur <- all_plastics %>%
  filter(lat > 34 ,
         lat < 71,
         long > -11.5 ,
         long < 40,
         !COUNTRY %in% c("Russian Federation", "Cyprus")) %>%
  mutate(region = "europe")
#check countries for errors
levels(as.factor(eur$COUNTRY))
#west africa
w_afr <- all_plastics %>%
  filter(lat > -35 ,
         lat < 38,
         long > -19 ,
         long < 22,
         !COUNTRY %in% c("Spain", "Portugal", "Greece")) %>%
  mutate(region = "west africa")
#check countries for errors
levels(as.factor(w_afr$COUNTRY))
#east africa
e_afr <- all_plastics %>%
  filter(
    lat > -35 ,
    lat < 38,
    long > 22 ,
    long < 52,
    !COUNTRY %in% c(
      "Cyprus",
      "Greece",
      "Turkey",
      "Israel",
      "Saudi Arabia",
      "Qatar",
      "Kuwait"
    )
  ) %>%
  mutate(region = "east africa")
#check countries for errors
levels(as.factor(e_afr$COUNTRY))
#Australia, New Zealand and some South Pacific Countries
w_pac <- all_plastics %>%
  filter(lat > -53 , lat < -8, long > 111 , long < 180, COUNTRY != "Indonesia") %>%
  mutate(region = "west pacific")
#check countries for errors
levels(as.factor(w_pac$COUNTRY))
#put em all together
plastic_regions <-
  bind_rows(
    atl_isles,
    cent_am,
    e_afr,
    e_south_am,
    eur,
    mid_east,
    n_asia,
    na_west,
    na_east,
    se_asia,
    w_afr,
    w_pac,
    w_south_am
  )
write_csv(plastic_regions, "plastic_regions.csv")


# Get sums of different plastic types for each region, and median lat/long
plastic_regions_grouped <-
  read_csv("plastic_regions.csv",
    guess_max = 5000
  ) %>% 
  group_by(region) %>% 
  summarize(meanLong=mean(na.omit(long)), 
            meanLat=mean(na.omit(lat)),
            `Total hard`=sum(SUM_Hard_PlasticBeverageBottle, 
                          SUM_Hard_OtherPlasticBottle, 
                          SUM_Hard_BucketOrCrate, 
                          SUM_Hard_Lighter, 
                          SUM_OtherHardPlastic, 
                          SUM_OtherHardPlastic, 
                          na.rm=TRUE),
            `Total soft`=sum(SUM_PlasticOrFoamPlatesBowlsCup,
                          SUM_Soft_Bag,
                          SUM_Soft_WrapperOrLabel,
                          SUM_Soft_Straw,
                          SUM_Soft_OtherPlastic,
                          SUM_Soft_CigaretteButts,
                          SUM_Soft_StringRingRibbon, 
                          na.rm=TRUE),
            `Total marine`=sum(Fishing_Net,
                            SUM_FishingLineLureRope,
                            Fishing_BuoysAndFloats, 
                          na.rm=TRUE),
            `Total other`=sum(SUM_HardOrSoft_PlasticBottleCap,
                           SUM_HardSoft_PersonalCareProduc,
                           SUM_Foam_OtherPlasticDebris, 
                          na.rm=TRUE)
  )
# Get total number of items for each region
total_items_per_region <- plastic_regions_grouped %>% 
  select(starts_with("total")) %>% 
  summarize(totalItems=rowSums(., na.rm=TRUE))
# Combine dataframes
plastic_regions_grouped <- cbind(plastic_regions_grouped, total_items_per_region)


  
  

```

Row
-----------------------------------------------------------------------

### Plastic waste around the world

```{r}
# Plot pie charts on map
# https://cran.r-project.org/web/packages/leaflet.minicharts/vignettes/introduction.html
library(leaflet)
library(leaflet.minicharts)
tilesURL <- "http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"
# Set colours for pie charts
# http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/
colors <- c("#D55E00", # rust
            "#E69F00", # gold
            "#009E73", # green
            "#999999") # grey
            
            #"#56B4E9") # light blue
            #"#0072B2") # dk blue
# Make map with overlaid charts
basemap <- leaflet(width = "100%", height = "400px") %>%
  addTiles(tilesURL)
basemap %>%
  addMinicharts(
    plastic_regions_grouped$meanLong, plastic_regions_grouped$meanLat,
    type = "pie",
    chartdata = plastic_regions_grouped[, colnames(plastic_regions_grouped[4:7])],
    colorPalette = colors,
    legend = TRUE,
    showLabels = TRUE,
    width = 60
    #width = 60 * log10(plastic_regions_grouped$totalItems) / log10(max(plastic_regions_grouped$totalItems)), transitionTime = 0
  )  %>% 
  addLabelOnlyMarkers (  # add labels for each region:  https://rstudio.github.io/leaflet/popups.html
    lng = plastic_regions_grouped$meanLong,
    lat = plastic_regions_grouped$meanLat + 5,
    label = str_to_title(unique(plastic_regions_grouped$region)),
    labelOptions = labelOptions(noHide = T,
                                direction = "top",
                                textOnly = TRUE,
                                textsize = "15px")
    )

```

Row
-----------------------------------------------------------------------

### Chart B

```{r}

```

### Chart C

```{r}

```

Row {data-height=100}
-----------------------------------------------------------------------

### References
```{r}
print(c("Dataset: https://cscloud-ec2020.opendata.arcgis.com/datasets/98631dc5bb9a4ea5a8f9c0b4ec433290_0?geometry=56.226%2C-46.748%2C-110.766%2C57.178"))
```
